# Linked-Files (Присоединенные файлы)

Существующая в "Парус-8" возможность хранения и управления присоединенными документами не лишена ряда недостатков. Из главных недостатков можно выделить следующие:
* практически неупраляемый рост размеров файлов базы данных, и как следствие увеличение размеров резервных копий БД;
* раздел присоединенные имеет свои права доступа, ни как не связанные с правами в разделах, к котором присоединены докуметы;
* не во всех разделах системы есть интерфейс присоединенных документов.

Данная разработка устраняет эти и другие недостатки, но в свою очередь имеет один собственный недостаток в сравнении с **_Присоединенными документами_**, а именно невозможность связывания одного файла с разными записями в разных разделах.

Подсистема присоединенных *файлов*, позволяет хранить файлы и (получать к ним доступ) независимо от базы данных, на внешних устройствах хранения.  Возможность присоединения файлов к записи может быть включена администратором для любого раздела. Пользователь имеющий права на просмотр записи в разделе, автоматически получает права на просмотр присоединенных файлов. Права на действия с присоединенными файлами полностью соответствуют правам на работу с записью в разделе, к котоой эти файлы присоединены. Т.е. если пользователь имеет право на добавление записи в каком-либо каталоге раздела, то у него будут права на присоединение файла к записям в этом каталоге. То же касается и операций редактирования и удаления присоединенных файлов.

## Инструкция по установке
1.	Под владельцем схемы Парус-8 выполнить скрипт `Linked-Files-Script.sql`
2.	Войти в модуль **_Администратор_** под русским интерфейсом.
3.	В разделе **_Предопределенный импорт_** выполнить импорт посылки `Linked-Files.prf`, установив чеккер *Игнорировать дату редакции*
4.	В разделе **_Приложения_** для записи с кодом `Admin` выполнить действие *Редактор меню*. 
  1.	В меню *Словари* сделать активным пункт *Свойства документов* и выполнить действие *Добавить*.
В окне свойств для заголовка и подсказки задать `Присоединенные файлы`
  2.	Сделать активным добавленный пункт меню *Присоединенные файлы* и выполнить действие *Добавить подменю*
В окне свойств в поле *Код* выбрать раздел `Разделы присоединенных файлов`, в поле *Метод* выбрать метод `main`, для заголовка задать значение `Разделы`
  3.	Сделать активным добавленный пункт меню *Разделы* и выполнить действие *Добавить*
В окне свойств в поле *Код* выбрать раздел `Места хранения присоединенных файлов`, в поле *Метод* выбрать метод `main`, для заголовка задать значение `Места хранения`
  4.	Закрыть редактор меню, сохранив изменения.
5.	Войти в модуль Администратор под украинским интерфейсом.
6.	В разделе **_Визначений імпорт_** выполнить импорт посылки `Linked-Files.prf`, установив чеккер *Ігнорувати дату редакції*
7.	В разделе *Застосунки* для записи с кодом `Admin`  выполнить действие *Редактор меню*. 
  1.	В меню *Словники* сделать активным пункт *Властивості документів* и выполнить действие *Додати*.
В окне свойств для заголовка и подсказки задать `Приєднані файли`
  2.	Сделать активным добавленный пункт меню *Приєднані файли* и выполнить действие *Додати підменю*
В окне свойств в поле *Код* выбрать раздел `Розділи приєднаних файлів`, в поле *Метод* выбрать метод `main`, для заголовка задать значение `Розділи`
  3.	Сделать активным добавленный пункт меню *Розділи* и выполнить действие *Додати*
В окне свойств в поле *Код* выбрать раздел `Місця зберігання приєднаних файлів`, в поле *Метод* выбрать метод `main`, для заголовка задать значение *Місця зберігання*
  4.	Закрыть редактор меню, сохранив изменения.
8. Создать роли `Администратор мест хранения присоединенных файлов` и `Администратор присоединенных файлов`.
9. Назначить роли *Администратор мест хранения присоединенных файлов* права на приложение `Администратор`, права на необходимые организации, и права доступа к разделу `Места хранения присоединенных файлов` и его действиям.
10. Назначить роли *Администратор присоединенных файлов* права на приложение `Администратор`, права на организацию `Система` и другие необходимые организации, и права доступа к разделу `Разделы присоединенных файлов` и его действиям, а также права на просмотр в разделе `Места хранения присоединенных файлов` и разделах организации *Система*: `Разделы системы`, `Системные словари` и `Таблицы системы`.
11. В разделе **_Пользовательские процедуры_** добавить процедуру с типом ручной неименованный блок (неавтоматический) с текстом
```sql
begin
  udo_pkg_linkeddocs.clear_expired(:ncompany);
end;
```
и указать привязку к организации для параметра `NCOMPANY`.

12. В разделе **_Пользовательские задания_** зарегистрировать задание для ежедневного выполнения, добавленной на предыдущем шаге, процедуры.

## Руководство администратора мест хранения присоединенных файлов
### Введение
В системе может быть заведено неограниченное количество мест хранения присоединенных файлов.
В качестве места хранения присоединенных файлов может быть использована:
* удаленная директория, доступная по протоколу FTP;
* локальная директория на сервере БД;
* удаленная директория смонтированная в файловую систему сервера БД.

Присоединенные пользователями файлы будут сохраняютя в подпапках указанной в качестве места хранения директории. Первая подпапка будет создана автоматически, когда пользователь присоединит какой-либо файл. В последствие, подпапки будут автоматически создаваться, когда во всех уже существующих подпапках количество файлов достигнет, задаваемого администратором, максимального количества.

При использовании FTP-папки, администратору БД необходимо предварительно настроить разрешения сетевого доступа к FTP-серверу с помощью **_Oracle Access Control List (ACL)_** 

При использовании локальной или смонтированной локально удаленной папки, администратору БД необходимо:
* создать объект БД `DIRECTORY`, ссылающийся на папку (пользователь сервера БД от имени которого работает СУБД должен иметь полные права на папку). Например:
```sql
create or replace directory UDO_PARUS_LINKED_FILES as '/home/oracle/linkfilesstore';
```
* дать привелегии `EXECUTE`, `READ` и `WRITE` для созданного объекта пользователю БД, являющемуся владельцем схемы "Парус". Например:
```sql
grant read, write on directory UDO_PARUS_LINKED_FILES to PARUS;
```
* дать следующие Java разрешения пользователю БД, являющемуся владельцем схемы "Парус", на операции в папке операционной системы, соответствующей созданной директории. Например:
```sql
EXEC dbms_java.grant_permission( 'PARUS', 'SYS:java.io.FilePermission', '/home/oracle/linkfilesstore', 'read' );
EXEC dbms_java.grant_permission( 'PARUS', 'SYS:java.io.FilePermission', '/home/oracle/linkfilesstore/-', 'read,write,delete' );
```

### Управление местами хранения присоединенных файлов
Для управления местами хранения присоединенных файлов, в системе предназначен одноименный раздел, вызываемый из гланого меню модуля  **Администратор** `Словари->Присоединенные файлы->Места хранения`. Раздел имеет стандартный для системы "Парус-8" интерфейс. В Левой части окна разделов расположено дерево каталогов, для разграничения прав доступа и структуризации мест хранения. В верхней части окна располагается список зарегистрированных мест хранения, в нижней - список подпапок в выбранном месте хранения с указанием текущего количества файлов в кажлой из них.

![Внешний вид раздела](https://raw.github.com/igorgo/Linked-Files/master/Docs/img/UdoFileStores_View.png)

При работе со списком мест хранения администратор может выполнить следующие основные действия
* Добавить
* Исправить
* Удалить

### Добавление места хранения присоединенных файлов
На форме добавления администратор указывает произвольный уникальный мнемокод и наименование места хранения, максимальное количество файлов в подпапках, и тип места хранения. При выборе, в качестве типа, значения **_Директория Oracle_**, необходимо указать имя соответствующего объекта `DIRECTORY` в БД. 

![Пример добавления места хранения с типом _Директория Oracle_](https://raw.github.com/igorgo/Linked-Files/master/Docs/img/UdoFileStores_AddDir.png)

При выборе, в качестве типа, значения **_Папка FTP-сервера_**, на появляющейся вкладке *Параметры FTP* необходимо указать параметры FTP-соединения.

![Пример добавления места хранения с типом _Папка FTP-сервера_](https://raw.github.com/igorgo/Linked-Files/master/Docs/img/UdoFileStores_AddFTP.png)

Заметьте, что указание IP-адреса необязательно, но при непустом его значении при соединении будет использоваться именно он, а указанное в этом случае доменное имя может и не существовать.

### Исправление места хранения присоединенных файлов
Администратор может изменить любой из реквизитов места хранения кроме типа. Таким образом невозможно преобразовать место хранения с типом *FTP-сервер* в место хранения с типом *Директория Oracle*, или наоборот.

При изменении реквизитов места хранения присоединенные файлы и подпапки не переносятся в новое указанное место. Администратор должен самостоятельно выполнить физический перенос всей структуры подпапок и файлов в них средствами операционной системы.

### Удаление места хранения присоединенных файлов
Администратор может удалить запись о месте хранения, только если в системе не зарегистрировано присоединенных файлов, хранящихся в удаляемом месте. В противном случае система выдаст сообщение об ошибке, с описанием причины невозможности удаления записи.

При удалении записи места хранения, не производится физического удаления содержимого папки, соответствующей удаляемому месту хранения.

## Руководство администратора присоединенных файлов
В задачу администратора присоединенных файлов, входит управление списком разделов системы "Парус-8", к записям которых пользователям будет дана возможность присоединять файлы. Для выполнения этой задаче в системе предназначен соответствующий раздел, вызываемый из гланого меню модуля  **Администратор** `Словари->Присоединенные файлы->Разделы`. Раздел имеет стандартный для системы "Парус-8" интерфейс и представляет собой список разделов, для которых доступна функция присоединения файлов, с указаним места и параметров хранения файлов.
Для каждого раздела системы администратор может выбирать место для их хранения, задать ограничение на размер одного файла и максимально количество файлов, которые могут быть присоединены к одной записи. Также существует возможность указать срок физического хранения присоединенных файлов. Срок отсчитывается от даты присоединения файла. По истечении срока система автоматически удаляет файлы из мест хранения, а записи об этих файлах в системе помечаются пометкой "Удален по сроку".

![Внешний вид раздела](https://raw.github.com/igorgo/Linked-Files/master/Docs/img/UdoLinkedFilesRules_View.png)

При работе со списком разделов администратор может выполнить следующие основные действия
* Добавить
* Исправить
* Удалить
* Блокировать
* Разблокировать

### Добавление раздела
На форме добавления администратор выбирает раздел системы, в котором необходимо добавить возможность присоединения файлов;

В группе полей *Условия хранения*, администратор 
* выбирает предварительно настроенное место хранения присоединенных файлов;
* указывает максимально допустимое количество файлов, которое пользователи смогут присоединить к одной записи раздела (при отсутствии ограничения необходимо задать значение `0`);
* указывает максимально допустимый размер файла, который можно будет присоединить в разделе (при отсутствии ограничения необходимо задать значение `0`);
* указывает срок хранения файлов присоединенных к записи (по истечении срока при необходимости отсутствии ограничения необходимо задать значение `0`);

![Пример добавления раздела присоединенных файлов](https://raw.github.com/igorgo/Linked-Files/master/Docs/img/UdoLinkedFilesRules_Edit.png)

### Исправление раздела
Администратор имеет возможность изменить любой из атрибутов раздела. Изменения любого параметра не влечет за собой изменений в размерах, количествах уже присоединенных файлов. При изменении места хранения, уже присоединенные к разделу, файлы остаются в старом месте. Срок хранения, уже присоединенных к разделу, файлов не изменяется. Все изменения в условиях и месте хранения будут касаться только новых файлов.

### Удаление раздела
Администратор может удалить запись о разделе, только если в системе не зарегистрировано файлов, присоединенных к этому разделу. В противном случае система выдаст сообщение об ошибке, с описанием причины невозможности удаления записи.

### Блокирование
Операция выполняется в случае необходимости временно или на постоянной основе заблокировать пользователям возможность присоединения файлов к записям раздела.

### Разблокирование
Операция выполняется для снятия временного блокирования возможности присоединения файлов к записям раздела. 

## Руководство пользователя
Для работы с присоединенными к записи файлами в разделе (для которого администратором включена такая возможность) предназначено действие **_Присоединенные файлы_**

![Вызов раздела](https://raw.github.com/igorgo/Linked-Files/master/Docs/img/UdoLinkedFiles_Call.png)

После выполнения действия откроется окно со списком присоединенных к записи файлов. Список содержит следующую информацию:
* имя файла;
* пользователь, присоединивший файл;
* дата и время присоединения файла;
* дата и время до которого файл будет доступен для скачивания;
* размер файла в килобайтах
* примечание к файлу;
* признак удаления файла по сроку хранения.

Работая со списком пользователь может присоединять новые файлы, удалять уже присоединенные, изменять примечание для уже присоединенных файлов и скачивать присоединенный файл.

### Присоединение файла
Для присоединения нового файла необходимо выполнить действие **Добавить**. В появившемся окне добавления, необходимо, нажав на кнопку `…` поля **_Файл_** выбрать действие **Загрузить…**. В результате будет отображен стандартный Windows-диалог выбора файла. Пользователю необходимо выбрать присоединяемый файл и нажать кнопку диалога `Открыть`. В результате имя файла и его размер будут автоматически вписаны в поля формы добаления. При необходимости на вкладке _Примечание_ можно ввести произвольный текст примечания к файлу. 

![Добавление](https://raw.github.com/igorgo/Linked-Files/master/Docs/img/UdoLinkedFiles_Add1.png)

### Исправление примечания присоединённого файла
Для исправления примечания присоединённого файла необходимо выполнить действие **Исправить**. В появившемся окне можно ввести новый текст примечания.

### Удаление присоединённого файла
Для удаления присоединённого файла необходимо выполнить действие **Удалить**. 

### Скачивание присоединенных файлов.
Для скачивания присоединенных файлов необходимо пометить в списке необходимые для скачивания файлы и выполнить действие **Скачать…**. После этого система загрузит файлы из мест их хранения в промежуточный буфер, содержимое которого будет показано пользователю. В окне буфера нужно пометить файлы, которые необходимо сохранить локально и выполнить действие **Сохранить…**, указав при этом локальную папку в которую нужно записать скачанные файлы.

![Буфер](https://raw.github.com/igorgo/Linked-Files/master/Docs/img/UdoLinkedFiles_Buff.png)



